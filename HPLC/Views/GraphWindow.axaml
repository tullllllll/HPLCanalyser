<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:HPLC.ViewModels"
             xmlns:views="clr-namespace:HPLC.Views"
             x:Class="HPLC.Views.GraphWindow"
             x:DataType="vm:MainViewModel"
             xmlns:local="clr-namespace:HPLC.Helpers">
    <UserControl.Resources>
        <local:InputConverterHelper x:Key="InputConverterHelper"/>
    </UserControl.Resources>

    <DockPanel>
        <TabControl DockPanel.Dock="Top" Margin="10" SelectedIndex="{Binding SelectedTabIndex}">
            <!-- Graph Viewer -->
            <TabItem Header="Graph View">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"></RowDefinition>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"></ColumnDefinition>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Graph Content -->
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*" /> 
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <views:GraphUserControl Grid.Row="0" DataContext="{Binding GraphViewModel}" x:Name="graphUserControl"/>

                        <Grid Grid.Row="1" ColumnDefinitions="Auto Auto *" Margin="10">
                            <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="5,0" Spacing="10">
                                <TextBlock Text="Threshold:" VerticalAlignment="Center"/>
                                <TextBox Width="100" Text="{Binding GraphViewModel.Threshold, Converter={StaticResource InputConverterHelper}, Mode=TwoWay}" />
                            </StackPanel>

                            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="5,0" Spacing="10">
                                <TextBlock Text="Min Width:" VerticalAlignment="Center"/>
                                <TextBox Width="100" Text="{Binding GraphViewModel.MinPeakWidth, Converter={StaticResource InputConverterHelper}, Mode=TwoWay, StringFormat='F1'}" />
                            </StackPanel>

                            <Button Grid.Column="2" Command="{Binding GraphViewModel.SaveImageCommand}" 
                                    Background="DodgerBlue" Foreground="White" 
                                    Cursor="Hand" HorizontalAlignment="Right">
                                <Image Height="16" Width="16" Source="avares://HPLC/Assets/download-image-icon.png" />
                            </Button>
                        </Grid>
                        
                        <!-- Expander for Peak Data -->
                        <Expander Header="Peak Data" IsExpanded="True" Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                            <DataGrid ItemsSource="{Binding GraphViewModel.Peaks}"
                                      AutoGenerateColumns="False"
                                      GridLinesVisibility="All"
                                      BorderThickness="1"
                                      BorderBrush="Gray"
                                      HorizontalAlignment="Stretch"
                                      VerticalScrollBarVisibility="Auto"
                                      MaxHeight="300"> <!-- Set a max height to show 5 items -->
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" IsReadOnly="false" />
                                    <DataGridTextColumn Header="Start" Binding="{Binding StartTime, StringFormat='F3'}" IsReadOnly="true" />
                                    <DataGridTextColumn Header="Peak" Binding="{Binding PeakTime, StringFormat='F3'}" IsReadOnly="true" />
                                    <DataGridTextColumn Header="End" Binding="{Binding EndTime, StringFormat='F3'}" IsReadOnly="true" />
                                    <DataGridTextColumn Header="Height" Binding="{Binding PeakHeight, StringFormat='F2'}" IsReadOnly="true" />
                                    <DataGridTextColumn Header="Area" Binding="{Binding Area, StringFormat='F1'}" IsReadOnly="true" />
                                    <DataGridTextColumn Header="Width ½ Height" Binding="{Binding WidthAtHalfHeight, StringFormat='F6'}" IsReadOnly="true" />
                                    
                                    <DataGridTemplateColumn Header="Color" IsReadOnly="true">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ColorPicker Tag="{Binding Tag}" Color="{Binding Color, Mode=TwoWay}" ColorChanged="ColorView_OnColorChanged" HorizontalAlignment="Stretch"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <DataGridTemplateColumn Header="" IsReadOnly="true">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Command="{Binding $parent[DataGrid].((vm:MainViewModel)DataContext).GraphViewModel.DeletePeakCommand}"  
                                                        CommandParameter="{Binding .}"
                                                        Background="Red"
                                                        Foreground="White"
                                                        HorizontalAlignment="Stretch"
                                                        HorizontalContentAlignment="Center"
                                                        FontWeight="Bold"
                                                        Cursor="Hand">
                                                    <TextBlock>X</TextBlock>
                                                </Button>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Expander>

                        <!-- GridSplitter to make the Expander draggable -->
                        <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" VerticalAlignment="Bottom" ResizeBehavior="PreviousAndNext" />
                    </Grid>
                    
                    <!-- Overlay if dataset is not visible -->
                    <Panel IsVisible="{Binding IsDatasetNull}">
                        <Border Background="Black" Opacity="0.4" />
                        <Button Content="Select DataSet" Command="{Binding SelectFileCommand}" 
                                CommandParameter="main" Background="DodgerBlue" Foreground="White" 
                                Margin="0,5" Cursor="Hand"
                                HorizontalAlignment="Center" FontSize="20"/>
                    </Panel>
                </Grid>
            </TabItem>

            <!-- Info tab -->
            <TabItem Header="Info">
                <TextBlock>Info tab</TextBlock>
            </TabItem>
            
            <!-- Settings -->
            <TabItem Header="Settings">
                <ScrollViewer>
                    <StackPanel Margin="10">
                        <TextBlock Text="Dataset Configuration" FontSize="26" FontWeight="Bold" Margin="0,0,0,10" HorizontalAlignment="Center"/>
                        
                        <Grid HorizontalAlignment="Center" Width="700">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            
                            <Border Background="#F8F8F8" Padding="15" BorderBrush="#CCC" BorderThickness="1" Grid.Column="0" Margin="0,0,10,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.ColumnSpan="2" FontWeight="Bold" FontSize="22" Margin="0,0,0,15" HorizontalAlignment="Center" Text="Main Dataset" />
                                    <TextBlock Grid.Row="1" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Name:" Margin="0,0,10,5"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" FontSize="16" VerticalAlignment="Center" Text="{Binding DataSet.Name}" Margin="0,0,0,5"/>
                                    
                                    <TextBlock Grid.Row="2" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Points:" Margin="0,0,10,5"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" FontSize="16" VerticalAlignment="Center" Text="{Binding DataSet.DataPoints.Count}" Margin="0,0,0,5"/>
                                    
                                    <TextBlock Grid.Row="3" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Sample Date:" Margin="0,0,10,5"/>
                                    <CalendarDatePicker Grid.Row="3" Grid.Column="1" FontSize="16" VerticalAlignment="Center" SelectedDate="{Binding DataSet.Sample_Date, Mode=TwoWay}" Margin="0,0,0,5"/>

                                    <TextBlock Grid.Row="4" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Color:" Margin="0,0,10,5"/>
                                    <ColorPicker Grid.Row="4" Grid.Column="1" Tag="Main" Color="Blue" ColorChanged="ColorView_OnColorChanged" Margin="0,5" HorizontalAlignment="Stretch" MaxWidth="350"/>

                                    <Button Grid.Row="5" Grid.ColumnSpan="2" Content="Select File" Command="{Binding SelectFileCommand}" CommandParameter="main" Background="DodgerBlue" Foreground="White" Margin="0,5" HorizontalAlignment="Stretch" MaxWidth="250"/>
                                    <Button Grid.Row="6" Grid.ColumnSpan="2" Content="Deselect" Command="{Binding DeselectFileCommand}" CommandParameter="main" Background="Red" Foreground="White" Margin="0,5" HorizontalAlignment="Stretch" MaxWidth="250"/>
                                </Grid>
                            </Border>

                            <Border Background="#F8F8F8" Padding="15" BorderBrush="#CCC" BorderThickness="1" Grid.Column="1" Margin="10,0,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="150" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.ColumnSpan="2" FontWeight="Bold" FontSize="22" Margin="0,0,0,15" HorizontalAlignment="Center" Text="Reference Dataset" />
                                    <TextBlock Grid.Row="1" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Name:" Margin="0,0,10,5"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" FontSize="16" VerticalAlignment="Center" Text="{Binding ReferenceDataSet.Name}" Margin="0,0,0,5"/>
                                    
                                    <TextBlock Grid.Row="2" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Points:" Margin="0,0,10,5"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" FontSize="16" VerticalAlignment="Center" Text="{Binding ReferenceDataSet.DataPoints.Count}" Margin="0,0,0,5"/>
                                    
                                    <TextBlock Grid.Row="3" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Dataset Added:" Margin="0,0,10,5"/>
                                    <CalendarDatePicker Grid.Row="3" Grid.Column="1" FontSize="16" VerticalAlignment="Center" SelectedDate="{Binding ReferenceDataSet.Sample_Date, Mode=TwoWay}" Margin="0,0,0,5"/>

                                    <TextBlock Grid.Row="4" Grid.Column="0" FontSize="16" VerticalAlignment="Center" Text="Color:" Margin="0,0,10,5"/>
                                    <ColorPicker Grid.Row="4" Grid.Column="1" Tag="Reference" Color="Red" ColorChanged="ColorView_OnColorChanged" Margin="0,5" HorizontalAlignment="Stretch" MaxWidth="350"/>

                                    <Button Grid.Row="5" Grid.ColumnSpan="2" Content="Select File" Command="{Binding SelectFileCommand}" CommandParameter="reference" Background="DodgerBlue" Foreground="White" Margin="0,5" HorizontalAlignment="Stretch" MaxWidth="250"/>
                                    <Button Grid.Row="6" Grid.ColumnSpan="2" Content="Deselect" Command="{Binding DeselectFileCommand}" CommandParameter="reference" Background="Red" Foreground="White" Margin="0,5" HorizontalAlignment="Stretch" MaxWidth="250"/>
                                </Grid>
                            </Border>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </DockPanel>
</UserControl>
